<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bonvi - NutPlan  </title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg: #0a0e1a;
  --surface: #111827;
  --surface2: #1a2236;
  --surface3: #243044;
  --accent: #00e5ff;
  --accent2: #7c3aed;
  --accent3: #f43f5e;
  --accent4: #10b981;
  --accent5: #f59e0b;
  --text: #e2e8f0;
  --text-muted: #64748b;
  --border: rgba(148,163,184,0.1);
  --glow: rgba(0,229,255,0.15);
  --glow2: rgba(124,58,237,0.12);
  --warning: #f59e0b;
  --warning-bg: rgba(245,158,11,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ ANIMATED BG ‚îÄ‚îÄ */
.bg-ambient {
  position: fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 80% 60% at 20% 20%, rgba(124,58,237,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 60% 50% at 80% 70%, rgba(0,229,255,0.06) 0%, transparent 70%),
    radial-gradient(ellipse 40% 40% at 60% 10%, rgba(244,63,94,0.05) 0%, transparent 70%);
  animation: ambientShift 12s ease-in-out infinite alternate;
}
@keyframes ambientShift {
  0%   { transform: scale(1) rotate(0deg); opacity:1; }
  100% { transform: scale(1.1) rotate(2deg); opacity:0.7; }
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.wrapper { position:relative; z-index:1; max-width:1440px; margin:0 auto; padding:24px 20px; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  text-align:center; padding: 48px 0 32px;
  animation: fadeDown 0.8s cubic-bezier(.22,1,.36,1) both;
}
@keyframes fadeDown { from { opacity:0; transform:translateY(-30px); } to { opacity:1; transform:translateY(0); } }

.header h1 {
  font-size: clamp(2.2rem, 5vw, 3.4rem);
  font-weight:800; letter-spacing:-2px;
  background: linear-gradient(135deg, var(--accent), var(--accent2), var(--accent3));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
}
.header .subtitle {
  color: var(--text-muted); font-size:0.95rem; margin-top:6px; font-weight:300; letter-spacing:2px; text-transform:uppercase;
}
.header .race-meta {
  display:flex; justify-content:center; gap:32px; margin-top:22px; flex-wrap:wrap;
}
.race-meta .meta-item {
  background: var(--surface); border:1px solid var(--border);
  border-radius:12px; padding:10px 22px;
  backdrop-filter:blur(8px);
  animation: fadeUp 0.6s cubic-bezier(.22,1,.36,1) both;
}
.race-meta .meta-item:nth-child(1) { animation-delay:.1s }
.race-meta .meta-item:nth-child(2) { animation-delay:.2s }
.race-meta .meta-item:nth-child(3) { animation-delay:.3s }
.meta-item .label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; }
.meta-item .value { font-size:1.2rem; font-weight:700; margin-top:2px; }
.meta-item .value .unit { font-size:0.75rem; color:var(--text-muted); margin-left:4px; font-weight:400; }

@keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

/* ‚îÄ‚îÄ SECTION TITLES ‚îÄ‚îÄ */
.section-title {
  font-size:1.1rem; font-weight:600; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:3px;
  margin: 36px 0 16px; padding-left:4px;
  display:flex; align-items:center; gap:12px;
}
.section-title::after { content:''; flex:1; height:1px; background:linear-gradient(90deg, var(--border), transparent); }
.section-title .dot { width:8px; height:8px; border-radius:50%; }

/* ‚îÄ‚îÄ CONFIG PANEL ‚îÄ‚îÄ */
.config-row {
  display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:14px;
  margin-bottom:28px;
}
.config-card {
  background: var(--surface); border:1px solid var(--border); border-radius:14px;
  padding:16px 18px; transition: all .25s;
  animation: fadeUp 0.5s cubic-bezier(.22,1,.36,1) both;
}
.config-card:hover { border-color: var(--accent); box-shadow:0 0 18px var(--glow); }
.config-card label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.2px; display:block; margin-bottom:6px; }
.config-card input[type=number] {
  width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px;
  color: var(--accent); font-family:'JetBrains Mono',monospace; font-size:1.05rem; font-weight:500;
  padding:8px 10px; outline:none; transition:.2s;
}
.config-card input[type=number]:focus { border-color:var(--accent); box-shadow:0 0 12px var(--glow); }

/* ‚îÄ‚îÄ MAIN SEGMENT TABLE ‚îÄ‚îÄ */
.table-scroll { overflow-x:auto; border-radius:18px; border:1px solid var(--border); }
.seg-table {
  width:100%; border-collapse:collapse; min-width:900px;
  background:var(--surface); font-size:0.82rem;
}
.seg-table thead th {
  background:var(--surface2); padding:12px 10px; text-align:center;
  font-weight:600; color:var(--text-muted); font-size:0.68rem;
  text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border);
  white-space:nowrap; position:sticky; top:0; z-index:2;
}
.seg-table thead th:first-child { text-align:left; padding-left:18px; }

.seg-table tbody tr {
  border-bottom:1px solid var(--border);
  transition: background .2s;
  animation: rowIn 0.5s cubic-bezier(.22,1,.36,1) both;
}
.seg-table tbody tr:nth-child(1){animation-delay:.05s}
.seg-table tbody tr:nth-child(2){animation-delay:.1s}
.seg-table tbody tr:nth-child(3){animation-delay:.15s}
.seg-table tbody tr:nth-child(4){animation-delay:.2s}
.seg-table tbody tr:nth-child(5){animation-delay:.25s}
.seg-table tbody tr:nth-child(6){animation-delay:.3s}
.seg-table tbody tr:nth-child(7){animation-delay:.35s}
.seg-table tbody tr:nth-child(8){animation-delay:.4s}
@keyframes rowIn { from { opacity:0; transform:translateX(-16px); } to { opacity:1; transform:translateX(0); } }

.seg-table tbody tr:hover { background: rgba(0,229,255,0.03); }
.seg-table tbody tr:last-child { border-bottom:none; }

.seg-table td { padding:9px 10px; text-align:center; }
.seg-table td:first-child { text-align:left; padding-left:18px; font-weight:600; color:var(--text); }

/* editable cells */
.seg-table input {
  width:100%; background:transparent; border:none; color:var(--text);
  font-family:'JetBrains Mono',monospace; font-size:0.82rem;
  text-align:center; padding:3px 0; outline:none; transition:.2s;
  -moz-appearance:textfield; appearance:textfield;
  -moz-appearance: textfield;
  appearance: textfield;
}
.seg-table input::-webkit-inner-spin-button,
.seg-table input::-webkit-outer-spin-button { -webkit-appearance:none; }
.seg-table input:focus { background:rgba(0,229,255,0.08); border-radius:6px; }
.seg-table input[type=text] { text-align:left; font-family:'Outfit',sans-serif; font-weight:500; }

/* computed cells */
.seg-table .calc { color:var(--text-muted); font-family:'JetBrains Mono',monospace; font-size:0.78rem; }
.seg-table .calc.speed { color:var(--accent4); font-weight:600; }
.seg-table .calc.carb  { color:var(--accent5); font-weight:600; }
.seg-table .calc.bor   { color:var(--accent); font-weight:600; }

/* column group dividers */
.seg-table .col-div { border-left:1px solid var(--border); }

/* ‚îÄ‚îÄ FOOD TABLE ‚îÄ‚îÄ */
.food-table {
  width:100%; border-collapse:collapse; min-width:900px;
  background:var(--surface); font-size:0.82rem;
}
.food-table thead th {
  background:var(--surface2); padding:12px 10px; text-align:center;
  font-weight:600; color:var(--text-muted); font-size:0.68rem;
  text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border);
  white-space:nowrap; position:sticky; top:0; z-index:2;
}
.food-table thead th:first-child { text-align:left; padding-left:18px; }

.food-table tbody tr {
  border-bottom:1px solid var(--border);
  transition: background .2s;
  animation: rowIn 0.5s cubic-bezier(.22,1,.36,1) both;
}
.food-table tbody tr:hover { background: rgba(244,63,94,0.03); }
.food-table tbody tr:last-child { border-bottom:none; }

.food-table td { padding:9px 10px; text-align:center; }
.food-table td:first-child { text-align:left; padding-left:18px; font-weight:600; color:var(--text); }

/* food table editable cells */
.food-table input,
.food-table select {
  width:100%; background:transparent; border:none; color:var(--text);
  font-family:'JetBrains Mono',monospace; font-size:0.82rem;
  text-align:center; padding:3px 0; outline:none; transition:.2s;
  appearance:none; -moz-appearance:none; -webkit-appearance:none;
  -moz-appearance:textfield; appearance:textfield;
}
.food-table .food-select {
  background:var(--surface2) !important; text-align:left; font-family:'Outfit',sans-serif;
  cursor:pointer; border:1px solid var(--border) !important; border-radius:4px !important;
  padding:4px 6px !important; transition:.2s !important; color:var(--text) !important;
}
.food-table .food-select:focus {
  background:var(--surface2) !important; border-color:var(--accent3) !important;
  box-shadow:0 0 8px rgba(244,63,94,0.2) !important; outline:none !important;
}
.food-table .food-select option {
  background:var(--surface) !important; color:var(--text) !important;
  padding:4px 6px !important;
}
.food-table input:focus,
.food-table select:focus { background:rgba(0,229,255,0.08); border-radius:6px; }
.food-table input[type=text] {
  text-align:left; font-family:'Outfit',sans-serif; font-weight:500;
  background:transparent; border:none; border-radius:0;
  color:var(--text); font-size:0.75rem; padding:2px 0; margin-top:2px;
}
.food-table input::-webkit-outer-spin-button,
.food-table input::-webkit-inner-spin-button { -webkit-appearance:none; }

/* food table computed cells */
.food-table .calc { color:var(--accent5); font-weight:600; font-family:'JetBrains Mono',monospace; font-size:0.78rem; }
.food-table .col-div { border-left:1px solid var(--border); }

/* ‚îÄ‚îÄ NUTRITION CARDS ‚îÄ‚îÄ */
.nut-grid {
  margin-top:8px;
}
.nut-grid.cards-view {
  display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:20px;
}
@media (max-width: 768px) {
  .nut-grid.cards-view {
    grid-template-columns:1fr;
    gap:16px;
  }
  .nut-card {
    padding:16px;
  }
}
.nut-card {
  background:var(--surface); border:1px solid var(--border); border-radius:16px;
  padding:20px; position:relative; overflow:hidden; transition: all .3s;
  animation: scaleIn 0.5s cubic-bezier(.22,1,.36,1) both;
}
.nut-card:hover { transform:translateY(-3px); box-shadow:0 8px 32px rgba(0,0,0,.3); border-color:var(--accent); }
@keyframes scaleIn { from { opacity:0; transform:scale(.94); } to { opacity:1; transform:scale(1); } }

.nut-card .card-glow {
  position:absolute; inset:-40%; border-radius:50%; opacity:.08;
  pointer-events:none; filter:blur(30px);
}
.nut-card .nt-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border); }
.nut-card .nt-name { font-weight:700; font-size:1.1rem; color:var(--text); }
.nut-card .nt-km { font-size:0.75rem; color:var(--text-muted); background:var(--surface2); padding:4px 12px; border-radius:20px; border:1px solid rgba(148,163,184,0.2); }
.nut-card .nt-food { font-size:0.78rem; color:var(--accent5); background:rgba(245,158,11,.08); padding:4px 10px; border-radius:8px; display:inline-block; margin-bottom:10px; }
.nut-card .nt-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.nt-stat { background:var(--surface2); border-radius:10px; padding:12px 14px; border:1px solid rgba(148,163,184,0.2); }
.nt-stat .st-label { font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:4px; }
.nt-stat .st-val { font-size:1rem; font-weight:700; font-family:'JetBrains Mono',monospace; }
.nt-stat .st-val.accent  { color:var(--accent); }
.nt-stat .st-val.accent2 { color:var(--accent2); }
.nt-stat .st-val.accent3 { color:var(--accent3); }
.nt-stat .st-val.accent4 { color:var(--accent4); }
.nt-stat .st-val.accent5 { color:var(--accent5); }

/* ‚îÄ‚îÄ BOTTLE SECTION ‚îÄ‚îÄ */
.bottle-row {
  display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:16px;
}
.bottle-row.cards-view {
  display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:16px;
}
.bottle-row.compact-view {
  display:block;
}
.bottle-card {
  background:var(--surface); border:1px solid var(--border); border-radius:18px;
  padding:20px; transition:.3s; animation: fadeUp 0.6s cubic-bezier(.22,1,.36,1) both;
}
.bottle-card:hover { border-color:var(--accent2); box-shadow:0 0 24px var(--glow2); }
.bottle-card h4 { font-size:0.72rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:14px; }
.bottle-card .bc-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid var(--border); font-size:0.82rem; }
.bottle-card .bc-row:last-child { border-bottom:none; }
.bottle-card .bc-row .bc-label { color:var(--text-muted); }
.bottle-card .bc-row .bc-val { font-family:'JetBrains Mono',monospace; font-weight:600; color:var(--accent); }
.bottle-card .bc-row .bc-val.purple { color:var(--accent2); }
.bottle-card .bc-row .bc-val.green  { color:var(--accent4); }
.bottle-card .bc-row .bc-val.amber  { color:var(--accent5); }

/* ‚îÄ‚îÄ FOOD INSTRUCTIONS ‚îÄ‚îÄ */
.food-instructions {
  display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;
}
.instruction-card {
  background:var(--surface); border:1px solid var(--border); border-radius:12px;
  padding:16px; text-align:center; animation: fadeUp 0.5s cubic-bezier(.22,1,.36,1) both;
}
.instruction-card:nth-child(1) { animation-delay:.1s }
.instruction-card:nth-child(2) { animation-delay:.2s }
.instruction-card h5 {
  font-size:0.85rem; font-weight:600; color:var(--accent3); margin-bottom:8px;
  text-transform:uppercase; letter-spacing:1px;
}
.instruction-card p {
  font-size:0.8rem; color:var(--text); margin-bottom:6px;
}
.instruction-card small {
  font-size:0.7rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace;
}

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
@media(max-width:720px) { .charts-grid { grid-template-columns:1fr; } }
.chart-box {
  background:var(--surface); border:1px solid var(--border); border-radius:18px;
  padding:20px; animation: fadeUp 0.6s cubic-bezier(.22,1,.36,1) both;
}
.chart-box h4 { font-size:0.72rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:14px; }
.chart-box .echarts-container { width:100%; height:260px; }

/* ‚îÄ‚îÄ LEGEND PILLS ‚îÄ‚îÄ */
.legend-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
.legend-pill { display:flex; align-items:center; gap:6px; font-size:0.72rem; color:var(--text-muted); }
.legend-pill .pill-dot { width:10px; height:10px; border-radius:50%; }

/* ‚îÄ‚îÄ BOTTLE VISUAL ‚îÄ‚îÄ */
.bottle-visual-wrap { display:flex; gap:24px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
.bottle-svg-wrap { text-align:center; }
.bottle-svg-wrap label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; display:block; margin-top:8px; }

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.tab-footer {
  margin-top:48px; padding-top:24px; border-top:1px solid var(--border);
  text-align:center; font-size:0.7rem; color:var(--text-muted);
  animation: fadeUp 0.5s cubic-bezier(.22,1,.36,1) both;
}
.tab-footer a { color:var(--accent); text-decoration:none; transition:.2s; }
.tab-footer a:hover { color:var(--accent2); text-decoration:underline; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:600px) {
  .config-row { grid-template-columns:1fr 1fr; }
  .charts-grid { grid-template-columns:1fr; }
}

/* scrollbar */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--surface2); border-radius:3px; }
::-webkit-scrollbar-thumb { background:var(--surface3); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--accent); }

/* ‚îÄ‚îÄ MODAL DIALOG ‚îÄ‚îÄ */
.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:999;
  align-items:center; justify-content:center;
}
.modal-overlay.active { display:flex; animation:fadeIn .2s ease; }
.modal-dialog {
  background:var(--surface); border:1px solid var(--border); border-radius:16px;
  padding:28px; max-width:480px; width:90%; box-shadow:0 16px 48px rgba(0,0,0,.4);
  animation: scaleIn .25s cubic-bezier(.22,1,.36,1);
}
.modal-dialog h3 {
  font-size:1.2rem; font-weight:700; margin-bottom:12px; color:var(--text);
}
.modal-dialog p {
  font-size:0.85rem; color:var(--text-muted); margin-bottom:14px; line-height:1.5;
}
.modal-dialog .osm-table {
  width:100%; border-collapse:collapse; margin:16px 0; font-size:0.8rem;
  background:var(--surface2); border-radius:8px; overflow:hidden;
}
.modal-dialog .osm-table th,
.modal-dialog .osm-table td {
  padding:10px 12px; text-align:center; border-bottom:1px solid var(--border);
}
.modal-dialog .osm-table th {
  background:var(--surface3); font-weight:600; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:1px; font-size:0.7rem;
}
.modal-dialog .osm-table tr:last-child td { border-bottom:none; }
.modal-dialog .osm-table .label { text-align:left; color:var(--text); font-weight:500; }
.modal-dialog .osm-table .value { font-family:'JetBrains Mono',monospace; font-weight:600; color:var(--accent5); }
.modal-dialog .osm-table .note { font-size:0.7rem; color:var(--text-muted); font-style:italic; }
.modal-buttons {
  display:flex; gap:12px; justify-content:flex-end; margin-top:20px;
}
.modal-btn {
  padding:9px 20px; border-radius:8px; font-size:0.85rem; font-weight:600;
  cursor:pointer; transition:.2s; border:none; font-family:'Outfit',sans-serif;
}
.modal-btn-close { background:var(--surface2); color:var(--text); }
.modal-btn-close:hover { background:var(--surface3); }

/* ‚îÄ‚îÄ SEGMENT PROGRESS BAR ‚îÄ‚îÄ */
.seg-progress { display:flex; height:6px; border-radius:3px; overflow:hidden; margin:12px 0 4px; background:var(--surface2); }
.seg-progress span { transition: width .4s ease; }

/* ‚îÄ‚îÄ TAB NAV ‚îÄ‚îÄ */
.tab-nav {
  display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; justify-content:center;
}
.tab-btn {
  background:var(--surface); border:1px solid var(--border); color:var(--text-muted);
  border-radius:30px; padding:9px 22px; font-size:0.82rem; font-weight:500;
  cursor:pointer; transition:.25s; font-family:'Outfit',sans-serif;
}
.tab-btn:hover { border-color:var(--accent); color:var(--text); }
.tab-btn.active { background:var(--accent); color:#0a0e1a; border-color:var(--accent); font-weight:700; box-shadow:0 0 16px var(--glow); }

.view-selector { display:flex; gap:2px; }
.view-btn {
  background:var(--surface2); border:1px solid var(--border); color:var(--text-muted);
  border-radius:6px; padding:3px; font-size:0.7rem; font-weight:500;
  cursor:pointer; transition:.25s; font-family:'Outfit',sans-serif;
  width:24px; height:24px; display:flex; align-items:center; justify-content:center;
}
.view-btn:hover { border-color:var(--accent); color:var(--text); }
.view-btn.active { background:var(--accent); color:#0a0e1a; border-color:var(--accent); font-weight:600; }

.tab-panel { display:none; }
.tab-panel.active { display:block; animation: fadeIn .35s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>
<div class="bg-ambient"></div>
<div class="wrapper">

<!-- HEADER -->
<div class="header">
  <h1>BONVI NUTPLAN</h1>
  <div class="subtitle">Nutrition & Hydration Planner</div>
  <div class="race-meta" id="raceMeta"></div>
</div>

<!-- TABS -->
<div class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('segments')">üìç Tratti & Tempo</button>
  <button class="tab-btn" onclick="switchTab('foods')">üçî Solidi</button>
  <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configurazione</button>
  <button class="tab-btn" onclick="switchTab('nutrition')">üçú Nutrizione</button>
  <button class="tab-btn" onclick="switchTab('bottles')">üíß Borracce</button>
  <button class="tab-btn" onclick="switchTab('charts')">üìä Grafici</button>
</div>

<!-- TAB: SEGMENTS -->
<div class="tab-panel active" id="tab-segments">
  <div class="table-scroll"><table class="seg-table" id="segTable"></table></div>
  <div class="tab-footer">¬© 2026 Andrea Bonvicin ‚Äî <strong>work in progress</strong> ‚Äî <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License 2.0</a></div>
</div>

<!-- TAB: FOODS -->
<div class="tab-panel" id="tab-foods">
  <div class="section-title"><span class="dot" style="background:var(--accent3)"></span>Solidi Disponibili <span onclick="showSolidiDialog()" style="cursor:pointer; color:var(--accent); font-weight:600;">‚ÑπÔ∏è</span></div>

  <div class="food-instructions">
    <div class="instruction-card">
      <h5>üç´ CHO Noti</h5>
      <p>Compila <strong>gr CHO/unit√†</strong> e <strong>Quantit√†</strong></p>
      <small>Es: Barretta = 30g CHO √ó 3 barrette = 90g CHO</small>
    </div>
    <div class="instruction-card">
      <h5>ü•ñ Custom</h5>
      <p>Compila <strong>% CHO</strong> e <strong>gr Alimento</strong></p>
      <small>Es: 100g caramelle al 75% = 75g CHO</small>
    </div>
  </div>

  <div class="table-scroll"><table class="food-table" id="foodTable"></table></div>
  <div class="section-title" style="margin-top:30px"><span class="dot" style="background:var(--accent5)"></span>Riepilogo CHO</div>
  <div class="food-summary-row" id="foodSummary"></div>
  <div class="tab-footer">¬© 2026 Andrea Bonvicin ‚Äî <strong>work in progress</strong> ‚Äî <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License 2.0</a></div>
</div>

<!-- TAB: CONFIG -->
<div class="tab-panel" id="tab-config">
  <div class="section-title"><span class="dot" style="background:var(--accent)"></span>Parametri di Configurazione</div>
  <div class="config-row" id="configRow"></div>
  <div class="tab-footer">¬© 2026 Andrea Bonvicin ‚Äî <strong>work in progress</strong> ‚Äî <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License 2.0</a></div>
</div>

<!-- TAB: NUTRITION -->
<div class="tab-panel" id="tab-nutrition">
  <div class="section-title"><span class="dot" style="background:var(--accent5)"></span>Piano Alimentare per Tratto</div>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
    <div class="view-selector">
      <button class="view-btn active" onclick="setNutritionView('cards')" title="Vista Cards">üìã</button>
      <button class="view-btn" onclick="setNutritionView('grid')" title="Vista Grid">‚äû</button>
    </div>
    <button onclick="autoFillChoPlanned()" style="background:var(--accent2); color:#0a0e1a; border:none; border-radius:6px; padding:6px 12px; font-size:0.75rem; cursor:pointer; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Auto CHO Totale</button>
  </div>
  <div class="nut-grid" id="nutGrid"></div>
  
  <div class="tab-footer">¬© 2026 Andrea Bonvicin ‚Äî <strong>work in progress</strong> ‚Äî <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License 2.0</a></div>
</div>

<!-- TAB: BOTTLES -->
<div class="tab-panel" id="tab-bottles">
  <div class="section-title"><span class="dot" style="background:var(--accent2)"></span>Configurazione Borracce</div>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
    <div class="view-selector">
      <button class="view-btn active" onclick="setBottleView('cards')" title="Vista Cards">üìã</button>
      <button class="view-btn" onclick="setBottleView('compact')" title="Vista Compatta">‚äû</button>
    </div>
    <button onclick="showOsmDialog()" style="background:var(--accent2); color:#0a0e1a; border:none; border-radius:6px; padding:6px 12px; font-size:0.75rem; cursor:pointer; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">‚ÑπÔ∏è Osmolarit√†</button>
  </div>
  <div class="bottle-row" id="bottleConfig"></div>
  <div class="section-title" style="margin-top:28px"><span class="dot" style="background:var(--accent)"></span>Piano Idratazione per Tratto</div>
  <div class="bottle-row" id="bottleCards"></div>
  <div class="tab-footer">¬© 2026 Andrea Bonvicin ‚Äî <strong>work in progress</strong> ‚Äî <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License 2.0</a></div>
</div>

<!-- TAB: CHARTS -->
<div class="tab-panel" id="tab-charts">
  <div class="charts-grid">
    <div class="chart-box"><h4>Velocit√† per Tratto</h4><div class="echarts-container" id="chartSpeed"></div></div>
    <div class="chart-box"><h4>Carboidrati: Piano vs Calcolato</h4><div class="echarts-container" id="chartCarbs"></div></div>
    <div class="chart-box"><h4>Consumo Borraccia per Tratto</h4><div class="echarts-container" id="chartBottle"></div></div>
    <div class="chart-box"><h4>Profilo Temporale</h4><div class="echarts-container" id="chartTime"></div></div>
    <div class="chart-box"><h4>Caffeina nel Sangue</h4><div class="echarts-container" id="chartCaffeine"></div></div>
  </div>
  <div class="tab-footer">¬© 2026 Andrea Bonvicin ‚Äî <strong>work in progress</strong> ‚Äî <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License 2.0</a></div>
</div>

</div><!-- /wrapper -->

<!-- FOOD SELECTOR MODAL -->
<div class="modal-overlay" id="foodSelectorModal" style="display:none;" onclick="closeFoodSelectorModal()">
  <div class="modal-dialog" style="max-width:500px;" onclick="event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0;">üçé Seleziona Integratore o Alimento</h3>
      <button onclick="closeFoodSelectorModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted); padding:0; line-height:1;">√ó</button>
    </div>
    <div id="foodSelectorContent">
      <!-- Content will be populated by JavaScript -->
    </div>
  </div>
</div>

<!-- OSM INFO MODAL -->
<div class="modal-overlay" id="osmModal">
  <div class="modal-dialog">
    <h3>üìä Osmolarit√† Suggerita</h3>
    <p>Scegli un livello di osmolarit√† in base al tuo comfort gastrointestinale e alla tolleranza.</p>
    
    <div id="osmTableContainer">
      <!-- Table will be populated by JavaScript -->
    </div>

    <p style="font-size:0.8rem; color:var(--accent5); margin-top:16px; padding:10px; background:rgba(245,158,11,.1); border-radius:6px;">
      <strong>üí° Consiglio:</strong> Inizia con 6% e regola in base alla tolleranza durante l'allenamento.
    </p>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeOsmDialog()">Chiudi</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="choModal">
  <div class="modal-dialog">
    <h3>ü•§ CHO % nei Carboidrati</h3>
    <p>Percentuale di carboidrati effettivi nei prodotti che utilizzi (sciroppi, succhi, malto ecc.).</p>
    
    <div style="margin:20px 0; padding:16px; background:var(--surface); border-radius:10px; border:1px solid var(--border);">
      <h4 style="margin:0 0 12px 0; color:var(--accent);">üìä Esempi Comuni</h4>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:0.85rem;">
        <div><strong>Malto:</strong> 90-99% (100% ok...)%</div>
        <div><strong>Sciroppo:</strong> 70-90%</div>
      </div>
    </div>

    <p style="font-size:0.8rem; color:var(--accent5); margin-top:16px; padding:10px; background:rgba(245,158,11,.1); border-radius:6px;">
      <strong>üí° Importante:</strong> Controlla sempre l'etichetta nutrizionale del prodotto per il valore esatto di carboidrati per 100g.
    </p>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeChoDialog()">Chiudi</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="carbModal">
  <div class="modal-dialog">
    <h3>‚ö° Rapporto Ottimale Carboidrati/h</h3>
    <p>Per assorbire efficientemente i carboidrati, il rapporto tra glucosio e fruttosio √® fondamentale.</p>
    
    <div style="margin:20px 0; padding:16px; background:var(--surface); border-radius:10px; border:1px solid var(--border);">
      <h4 style="margin:0 0 12px 0; color:var(--accent);">üìà Linee Guida</h4>
      <div style="display:grid; gap:12px; font-size:0.85rem;">
        <div><strong>Fino a 60 gr/h:</strong> Solo glucosio (100%)</div>
        <div><strong>70 gr/h:</strong> Glucosio 60g + Fruttosio 10g</div>
        <div><strong>80 gr/h:</strong> Glucosio 60g + Fruttosio 20g</div>
        <div><strong>90 gr/h:</strong> Glucosio 60g + Fruttosio 30g</div>
        <div><strong>100 gr/h:</strong> Glucosio 60g + Fruttosio 40g</div>
        <div><strong>120 gr/h:</strong> Glucosio 60g + Fruttosio 60g</div>
      </div>
    </div>

    <div id="carbReminder" style="margin:16px 0; padding:12px; background:rgba(0,229,255,0.1); border:1px solid var(--accent); border-radius:6px; color:var(--text);">
    </div>

    <p style="font-size:0.8rem; color:var(--accent5); margin-top:16px; padding:10px; background:rgba(245,158,11,.1); border-radius:6px;">
      <strong>üí° Consiglio:</strong> Oltre i 60 gr/h, aggiungi fruttosio per migliorare l'assorbimento intestinale.
    </p>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeCarbDialog()">Chiudi</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="caffeineModal">
  <div class="modal-dialog" style="max-width:480px; max-height:70vh; overflow-y:auto;">
    <h3>‚òï Gestione Caffeina</h3>
    <p style="font-size:0.95rem;">La caffeina segue un decadimento esponenziale (emivita) nel corpo.</p>
    
    <div style="margin:12px 0 20px 0; padding:16px; background:var(--surface); border-radius:10px; border:1px solid var(--border);">
      <h4 style="margin:0 0 8px 0; color:var(--accent);">üìä Formula di Calcolo</h4>
      <div style="font-family:'JetBrains Mono',monospace; font-size:1.1rem; margin:8px 0 12px 0; text-align:center; background:rgba(0,229,255,0.06); padding:8px 10px; border-radius:4px;">
        C(t) = C‚ÇÄ ¬∑ (¬Ω)<sup>t/t¬Ω</sup>
      </div>

      <div style="display:grid; gap:8px; font-size:0.95rem;">
        <div><strong>C‚ÇÄ</strong> = Dose iniziale (mg)</div>
        <div><strong>t</strong> = Tempo trascorso (ore)</div>
        <div><strong>t¬Ω</strong> = Emivita (ore)</div>
        <div><strong>C(t)</strong> = Caffeina residua</div>
      </div>

      <hr style="margin:12px 0; border:none; border-top:1px solid var(--border);">

      <div style="display:grid; gap:10px; font-size:0.95rem;">
        <div style="font-weight:700; color:var(--accent);">üß¨ Variabilit√† Interindividuale</div>
        <div><strong>Interindividuale:</strong> 78,6% (differenze tra persone)</div>
        <div><strong>Intraindividuale:</strong> 21,4% (variazioni nello stesso individuo)</div>
        <div style="margin-top:6px; padding:8px; background:rgba(0,229,255,0.06); border-radius:6px; font-size:0.9rem;">La velocit√† di eliminazione varia significativamente tra gli individui</div>

        <div style="font-weight:700; color:var(--accent); margin-top:8px;">‚è±Ô∏è Emivita Tipica</div>
        <div><strong>~5 ore (default):</strong> Adulto sano</div>
        <div><strong>‚Üì 3 ore:</strong> Fumatori</div>
        <div><strong>‚Üë 7 ore:</strong> Gravidanza, contraccettivi orali</div>

        <div style="font-weight:700; color:var(--accent); margin-top:8px;">üìç Timing di Assunzione</div>
        <div>Si assume che la caffeina raggiunga il picco ematico <strong>a met√† segmento di assunzione</strong></div>
      </div>
    </div>

    <p style="font-size:0.95rem; color:var(--accent5); margin-top:8px; padding:10px; background:rgba(245,158,11,.06); border-radius:6px;">
      <strong>üí° Nota:</strong> I valori mostrati sono teorici. La tua esperienza individuale potrebbe differire significativamente.
    </p>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeCaffeineFormula()">Chiudi</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="choBottleModal">
  <div class="modal-dialog">
    <h3>ü•§ CHO per Borraccia</h3>
    <p>Qui inserisci i grammi di carboidrati decisi da inserire nella borraccia, sulla base della osmolarit√† preferita.</p>
    
    <div style="margin:20px 0; padding:16px; background:var(--surface); border-radius:10px; border:1px solid var(--border);">
      <h4 style="margin:0 0 12px 0; color:var(--accent);">‚ö†Ô∏è Campo Cruciale</h4>
      <div style="display:grid; gap:12px; font-size:0.85rem;">
        <div>‚Ä¢ <strong>NON opzionale:</strong> Questo valore determina tutti i calcoli nelle tab seguenti</div>
        <div>‚Ä¢ <strong>Carboidrati per borraccia:</strong> Grammi che manterrai nella borraccia per tutto l'allenamento</div>
        <div>‚Ä¢ <strong>Calcolo osmolarit√†:</strong> Verr√† calcolata automaticamente (grammi / volume √ó 100)</div>
        <div>‚Ä¢ <strong>Distribuzione rimanenti:</strong> I CHO liquidi restanti verranno distribuiti nelle altre borracce</div>
        <div>‚Ä¢ <strong>Decisione strategica:</strong> Scegli un valore realistico e sostenibile per la tua performance</div>
      </div>
    </div>

    <p style="font-size:0.8rem; color:var(--accent5); margin-top:16px; padding:10px; background:rgba(245,158,11,.1); border-radius:6px;">
      <strong>‚ö†Ô∏è Importante:</strong> Questo valore √® fondamentale per tutti i calcoli successivi. Scegli con attenzione un quantitativo sostenibile per il tuo allenamento/gara.
    </p>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeChoBottleDialog()">Chiudi</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="solidiModal">
  <div class="modal-dialog">
    <h3>üçΩÔ∏è Cosa sono i Solidi?</h3>
    <p>I solidi comprendono tutti gli alimenti che <strong>NON</strong> vengono sciolti nella borraccia.</p>
    
    <div style="margin:20px 0; padding:16px; background:var(--surface); border-radius:10px; border:1px solid var(--border);">
      <h4 style="margin:0 0 12px 0; color:var(--accent);">üì¶ Esempi di Solidi</h4>
      <div style="display:grid; gap:12px; font-size:0.85rem;">
        <div><strong>üçØ Gel:</strong> Anche se liquidi, vengono considerati solidi perch√© assunti direttamente</div>
        <div><strong>üç´ Barrette energetiche:</strong> Solidi da masticare</div>
        <div><strong>üçå Frutta:</strong> Banana, datteri, ecc.</div>
        <div><strong>üç™ Biscotti e dolci:</strong> Qualsiasi alimento solido</div>
        <div><strong>ü•ñ Pane e carboidrati solidi:</strong> Tutto ci√≤ che non va in borraccia</div>
      </div>
    </div>

    <p style="font-size:0.8rem; color:var(--accent4); margin-top:16px; padding:10px; background:rgba(16,185,129,.1); border-radius:6px;">
      <strong>üí° Suggerimento:</strong> Per i carboidrati liquidi (sciolti in acqua) vai alla schermata <strong>"üíß Borracce"</strong>.
    </p>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeSolidiDialog()">Chiudi</button>
    </div>
  </div>
</div>

<!-- REFILL MODAL -->
<div class="modal-overlay" id="refillModal" style="display:none;" onclick="closeRefillModal()">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <h3>‚ö†Ô∏è Istruzioni Refill</h3>
    <p>Quando il consumo supera 1 borraccia, devi refillare la borraccia successiva usando la borraccia iperconcentrata diluita con acqua.</p>
    
    <div id="refillContent" style="margin:20px 0;">
      <!-- Content will be populated by JavaScript -->
    </div>

    <div class="modal-buttons">
      <button class="modal-btn modal-btn-close" onclick="closeRefillModal()">Chiudi</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODEL ‚Äî faithfully ported from NUT_LUNGO.xlsx
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ CONFIG (editable globals) ‚îÄ‚îÄ
const cfg = {
  carbPerHour: 80,       // R15 ‚Äî carbo/h target
  bottleVol: 950,        // S20 ‚Äî borraccia ml
  osmGr: 120,            // U18 ‚Äî gr osmolarit√† borraccia easy
  siroSugar: 93,         // S23 ‚Äî sciroppo sugar %
  targetOsm: 6,          // Target osmolarit√† % per borraccia 1 (4-8%)
  choPerBottle: 0,       // Inserisci grammi CHO manuali per borraccia (opzionale)
  caffeineHalfLife: 5,   // Emivita caffeina in ore (default 5h)
};

// ‚îÄ‚îÄ SEGMENTS (input data) ‚îÄ‚îÄ
// Each: { name, km, h, min, carbo (planned), carboInt (CHO ing), malto (CHO borraccia), consum, foodItems[] }
let segments = [
  { name:'Molina',    km:45,  h:2, min:0,  carbo:null, carboInt:0, malto:0, consum:0.7,  foodItems:[] },
  { name:'Vic',       km:80,  h:1, min:20, carbo:null, carboInt:0, malto:0, consum:null, foodItems:[] },
  { name:'Canazei',   km:90,  h:0, min:25, carbo:null, carboInt:0, malto:0, consum:0.8,  foodItems:[] },
  { name:'Fedaia',    km:100, h:0, min:55, carbo:null, carboInt:0, malto:0, consum:null, foodItems:[] },
  { name:'Agordino',  km:130, h:0, min:50, carbo:null, carboInt:0, malto:0, consum:0.7,  foodItems:[] },
  { name:'Valles',    km:150, h:1, min:30, carbo:null, carboInt:0, malto:0, consum:null, foodItems:[] },
  { name:'Cavalese',  km:185, h:1, min:0,  carbo:null, carboInt:0, malto:0, consum:1.0,  foodItems:[] },
  { name:'Casa',      km:230, h:2, min:0,  carbo:null, carboInt:0, malto:0, consum:null, foodItems:[] },
];

// ‚îÄ‚îÄ NUTRITION VIEW ‚îÄ‚îÄ
let nutritionView = 'cards'; // 'cards' or 'grid'
let bottleView = 'cards'; // 'cards' or 'compact'

// ‚îÄ‚îÄ FOODS (input data) ‚îÄ‚îÄ
// Each: { type, grCho, qty, pctCho, grFood, customName, caffeineMg }
let foods = [
  { type:'barretta', grCho:null, qty:1, pctCho:null, grFood:null, customName:'', caffeineMg:0 },
];

// ‚îÄ‚îÄ AVAILABLE FOOD INSTANCES ‚îÄ‚îÄ
// Array of {foodIndex, instanceId} representing available food units
let availableFoodInstances = [];

function updateAvailableFoodInstances() {
  availableFoodInstances = [];
  foods.forEach((food, foodIndex) => {
    const qty = food.qty || 1;
    for (let i = 0; i < qty; i++) {
      availableFoodInstances.push({ foodIndex, instanceId: i });
    }
  });
  
  // Remove instances that are already assigned to segments
  segments.forEach(segment => {
    if (segment.foodItems) {
      segment.foodItems.forEach(item => {
        const instanceIndex = availableFoodInstances.findIndex(inst => 
          inst.foodIndex === item.foodIndex && inst.instanceId === item.instanceId
        );
        if (instanceIndex >= 0) {
          availableFoodInstances.splice(instanceIndex, 1);
        }
      });
    }
  });
}

// ‚îÄ‚îÄ COMPUTED STATE (recalculated reactively) ‚îÄ‚îÄ
let computed = [];
let debounceTimer = null;

function recalc() {
  updateAvailableFoodInstances();
  
  // gr iper: acqua disponibile per la miscela iper (poch√® non usiamo pi√π 'planFluid')
  const grIper   = cfg.bottleVol - cfg.osmGr;      // ex: 950 - 120 = 830
  const pctIper  = cfg.osmGr / grIper;             // rapporto malto/acqua
  const osmPct   = cfg.osmGr / cfg.bottleVol;      // percentuale osm rispetto al volume della borraccia (g/ml) in unit√† adimensionale

  computed = [];
  let cumMin = 0, cumTime = 0, cumMalto = 0, cumIper = 0, cumBor = 0;

  segments.forEach((s, i) => {
    if (!s.foodItems) s.foodItems = [];
    const choPlanned = s.carbo !== null && s.carbo !== '' ? Number(s.carbo) : null;
    const choIng = calcSegmentChoIng(s);
    const choBorraccia = choPlanned !== null ? Math.max(0, choPlanned - choIng) : 0;
    s.carboInt = choIng;
    s.malto = choBorraccia;

    // Calculate bottle consumption based on CHO planned and bottle CHO capacity
    if (choPlanned !== null && cfg.choPerBottle > 0) {
      s.consum = choPlanned / cfg.choPerBottle;
    } else {
      s.consum = null;
    }

    // duration
    const segMin  = s.h * 60 + s.min;  // G = C*60 + D (for all rows, not just i>0)
    cumMin       += segMin;
    const cumH    = Math.floor(cumMin / 60);
    const cumM    = cumMin - cumH * 60;
    const cumTimeDec = cumH + cumM / 60;           // L

    // deltas
    const prevKm   = i > 0 ? segments[i-1].km : 0;
    const prevTime = i > 0 ? computed[i-1].cumTimeDec : 0;
    const dKm      = s.km - prevKm;                // M
    const dTime    = cumTimeDec - prevTime;         // N

    const avgSpeed = cumTimeDec > 0 ? s.km / cumTimeDec : 0;  // velocit√† media cumulativa fino a questo punto
    const segSpeed = dTime > 0 ? dKm / dTime : 0; // velocit√† del segmento corrente

    // nutrition
    const carboCalc = cfg.carbPerHour * dTime;     // O = carboC
    // Auto-fill CHO planned if empty
    if (s.carbo === null || s.carbo === '') {
      s.carbo = Math.round(carboCalc);
    }
    cumMalto += s.malto;                           // T (cumulative)

    // bottle
    const borFrac = s.malto / cfg.osmGr;           // U = malto / 120
    const refill  = s.consum !== null ? s.consum * pctIper : null;     // W
    const refillH2O = s.consum !== null ? s.consum - refill : null;    // X
    const refillMl  = refill !== null ? cfg.bottleVol * refill : null; // Y  (S20 * W)
    const refillH2OmL = refillH2O !== null ? cfg.bottleVol * refillH2O : null; // Z - ml H2O consumati (parte acqua)
    const fillIper = borFrac / 3;                  // AA = U/3
    cumIper += fillIper;
    cumBor  += borFrac;

    computed.push({
      i, name: s.name, km: s.km,
      segMin, cumMin, cumH, cumM, cumTimeDec,
      dKm, dTime, avgSpeed, segSpeed,
      carboCalc, carbo: s.carbo, carboInt: s.carboInt,
      malto: s.malto, cumMalto,
      borFrac, consum: s.consum, refill, refillH2O, refillMl, refillH2OmL,
      fillIper, cumIper, cumBor
    });
  });
  return { grIper, pctIper, osmPct, cumMalto, cumIper, cumBor };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function fmt(n, d=1) { return n == null ? '‚Äî' : n.toFixed(d); }

function fmtDuration(mins) {
  const h = Math.floor(mins / 60);
  const m = Math.round(mins - h * 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function calcFoodChoPerUnit(food) {
  if (!food) return 0;
  if (food.grCho !== null && food.grCho !== '') return Number(food.grCho) || 0;
  if (food.pctCho !== null && food.grFood !== null && food.grFood !== '') {
    return (Number(food.grFood) * Number(food.pctCho) / 100) || 0;
  }
  return 0;
}

function foodLabel(food) {
  if (!food) return '‚Äî';
  const name = food.type === 'altro' && food.customName ? food.customName : food.type;
  const cho = calcFoodChoPerUnit(food);
  const choText = cho > 0 ? `${fmt(cho,0)}g CHO` : 'CHO ?';
  const caffText = food.caffeineMg > 0 ? ` (${food.caffeineMg}mg caffeina)` : '';
  return `${name} ${choText}${caffText}`;
}

function showFoodSelectorModal(segIdx) {
  const modal = document.getElementById('foodSelectorModal');
  const content = document.getElementById('foodSelectorContent');
  
  let html = '<div style="max-height:400px; overflow-y:auto;">';
  
  if (availableFoodInstances.length === 0) {
    html += '<div style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">Nessun alimento disponibile</div>';
  } else {
    availableFoodInstances.forEach((instance, index) => {
      const food = foods[instance.foodIndex];
      const label = foodLabel(food);
      html += `
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; margin-bottom:8px; background:var(--surface2); border-radius:8px; cursor:pointer; transition:background .2s;" 
             onmouseover="this.style.background='var(--surface3)'" 
             onmouseout="this.style.background='var(--surface2)'"
             onclick="selectFoodInstance(${segIdx}, ${index})">
          <span style="font-weight:500;">${label}</span>
          <span style="color:var(--accent4); font-size:0.8rem;">+</span>
        </div>
      `;
    });
  }
  
  html += '</div>';
  content.innerHTML = html;
  modal.style.display = 'flex';
}

function closeFoodSelectorModal() {
  document.getElementById('foodSelectorModal').style.display = 'none';
}

function selectFoodInstance(segIdx, instanceIndex) {
  const instance = availableFoodInstances[instanceIndex];
  if (!segments[segIdx].foodItems) segments[segIdx].foodItems = [];
  
  // Add the selected instance to the segment
  segments[segIdx].foodItems.push({
    foodIndex: instance.foodIndex,
    instanceId: instance.instanceId
  });
  
  // Close modal and re-render
  closeFoodSelectorModal();
  debouncedRenderAll();
}

function calcSegmentChoIng(seg) {
  if (!seg.foodItems || seg.foodItems.length === 0) return 0;
  return seg.foodItems.reduce((sum, item) => {
    const foodIndex = (item.foodIndex >= 0 && item.foodIndex < foods.length) ? item.foodIndex : 0;
    const food = foods[foodIndex];
    const perUnit = calcFoodChoPerUnit(food);
    return sum + perUnit; // Each item represents 1 unit
  }, 0);
}

function addSegmentFood(segIdx) {
  if (!segments[segIdx].foodItems) segments[segIdx].foodItems = [];
  showFoodSelectorModal(segIdx);
}

function removeSegmentFood(segIdx, rowIdx) {
  if (!segments[segIdx].foodItems) return;
  const removedItem = segments[segIdx].foodItems.splice(rowIdx, 1)[0];
  // The removed item becomes available again
  debouncedRenderAll();
}

function autoFillChoPlanned() {
  // Fill empty CHO planned fields with corresponding CHO calculated values (rounded to integers)
  segments.forEach((segment, index) => {
    if (segment.carbo === null || segment.carbo === '') {
      // Find the corresponding computed value
      const computedSegment = computed[index];
      if (computedSegment && computedSegment.carboCalc) {
        segment.carbo = Math.round(computedSegment.carboCalc);
      }
    }
  });
  debouncedRenderAll();
}

function renderAll() {
  const meta = recalc();
  renderHeader(meta);
  renderConfig();
  renderTable();
  renderFoods();
  renderNutrition(meta);
  renderBottles(meta);
  // Charts only render on tab switch or after debounce
}

function renderAllWithCharts() {
  renderAll();
  renderCharts();
}

// Debounced render function - waits 800ms after last keystroke
function debouncedRenderAll() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(renderAllWithCharts, 800);
}

function addFood() {
  foods.push({ type:'barretta', grCho:null, qty:1, pctCho:null, grFood:null, customName:'', caffeineMg:0 });
  debouncedRenderAll();
}

function removeFood(index) {
  if (foods.length > 1) {
    foods.splice(index, 1);
    debouncedRenderAll();
  }
}

function renderHeader(meta) {
  const totalKm = segments[segments.length-1].km;
  const totalTime = computed[computed.length-1].cumTimeDec;
  const avgSpeed = totalKm / totalTime;
  document.getElementById('raceMeta').innerHTML = `
    <div class="meta-item"><div class="label">Distanza</div><div class="value">${totalKm}<span class="unit">km</span></div></div>
    <div class="meta-item"><div class="label">Durata Est.</div><div class="value">${computed[computed.length-1].cumH}h ${computed[computed.length-1].cumM}m</div></div>
    <div class="meta-item"><div class="label">Velocit√† Media</div><div class="value">${fmt(avgSpeed)}<span class="unit">km/h</span></div></div>
  `;
}

function renderConfig() {
  // Calcoli cascata per borracce
  const totalTime = computed.length > 0 ? computed[computed.length-1].cumTimeDec : 0;
  const totalChoCalc = cfg.carbPerHour * totalTime;
  
  // CHO alimenti solidi (da tab Foods)
  const totalChoFood = foods.reduce((sum, f) => {
    let calcCho = 0;
    const qty = f.qty || 1;
    if (f.grCho !== null && f.grCho !== '') {
      calcCho = f.grCho * qty;
    } else if (f.pctCho !== null && f.grFood !== null && f.grFood !== '') {
      calcCho = (f.grFood * f.pctCho / 100) * qty;
    }
    return sum + calcCho;
  }, 0);

  // CHO liquidi rimanenti
  const choLiquid = totalChoCalc - totalChoFood;
  
  // Borraccia 1: inserita manualmente dall'utente
  const borr1Cho = Number(cfg.choPerBottle) || 0;
  const borr1Source = borr1Cho > 0 ? 'manuale' : 'nessuna';
  
  // Osm effettiva risultante dalla quantit√† di CHO inseriti (in %)
  const computedOsm = borr1Cho > 0 && cfg.bottleVol > 0 ? (borr1Cho * 100) / cfg.bottleVol : null;

  // Borraccia 2: osmolare ottimale (calcolata dal Target Osm) - CHO effettivi
  const borr2Cho = (cfg.bottleVol / 1000) * cfg.targetOsm * 10;
  
  // Massa totale carboidrati per borraccia ottimale
  const borr2Mass = borr2Cho / ((cfg.choPercentage || 100) / 100);
  
  // Massa totale carboidrati per borraccia custom
  const borrCustomMass = computedOsm !== null ? ((cfg.bottleVol * computedOsm) / 100) / ((cfg.choPercentage || 100) / 100) : null;
  
  // Borraccia iperconcentrata: CHO liquidi rimanenti - CHO inseriti manualmente
  const borrIperCho = Math.max(0, choLiquid - borr1Cho);
  
  // Borraccia iperconcentrata con ottimale: CHO liquidi rimanenti - CHO borraccia ottimale
  const borrIperOptimalCho = Math.max(0, choLiquid - borr2Cho);
  
  // Liquidi necessari per osm ottimale con CHO rimanenti (ml)
  const liquidForOptimalOsm = choLiquid > 0 && cfg.targetOsm > 0 ? (choLiquid * 1000) / (cfg.targetOsm * 10) : 0;

  document.getElementById('configRow').innerHTML = `
    <div class="config-card"><label>Carbo/h (g) <span onclick="showCarbDialog()" style="cursor:pointer; color:var(--accent); font-weight:600;">‚ÑπÔ∏è</span></label><input type="number" value="${cfg.carbPerHour}" oninput="cfg.carbPerHour=+this.value;debouncedRenderAll()"></div>
    <div class="config-card"><label>Emivita Caffeina (h) <span onclick="showCaffeineDialog()" style="cursor:pointer; color:var(--accent); font-weight:600;">‚ÑπÔ∏è</span></label><input type="number" step="0.5" min="1" max="10" value="${cfg.caffeineHalfLife}" oninput="cfg.caffeineHalfLife=+this.value;debouncedRenderAll()"></div>
    <div class="config-card"><label>Vol. Borraccia (ml)</label><input type="number" value="${cfg.bottleVol}" oninput="cfg.bottleVol=+this.value;debouncedRenderAll()"></div>
    <div class="config-card"><label>Target Osm. % <span onclick="showOsmDialog()" style="cursor:pointer; color:var(--accent); font-weight:600;">‚ÑπÔ∏è</span></label><input type="number" step="0.5" min="2" max="10" value="${cfg.targetOsm}" oninput="cfg.targetOsm=+this.value;debouncedRenderAll()"></div>
    <div class="config-card"><label>CHO per Borraccia (g) <span onclick="showChoBottleDialog()" style="cursor:pointer; color:var(--accent); font-weight:600;">‚ÑπÔ∏è</span></label><input type="number" step="1" value="${cfg.choPerBottle || ''}" placeholder="!!leggi info!!" oninput="cfg.choPerBottle=this.value?+this.value:0;debouncedRenderAll()"></div>
        <div class="config-card"><label>CHO % soluto <span onclick="showChoDialog()" style="cursor:pointer; color:var(--accent); font-weight:600;">‚ÑπÔ∏è</span></label><input type="number" step="5" min="1" max="100" value="${cfg.choPercentage || 100}" oninput="cfg.choPercentage=+this.value;debouncedRenderAll()"></div>
  `;

  // Summary borracce
  const summaryHtml = `
    <div style="margin-top:32px; padding:20px; background:var(--surface2); border-radius:14px; border:1px solid var(--border);">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px;">
        <!-- CHO totali -->
        <div style="text-align:center; padding:16px; background:var(--surface); border-radius:10px;">
          <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">CHO Totali</div>
          <div style="font-size:1.8rem; font-weight:800; color:var(--accent5); font-family:'JetBrains Mono',monospace;">${fmt(totalChoCalc, 0)} g</div>
        </div>
        
        <!-- CHO Solidi -->
        <div style="text-align:center; padding:16px; background:var(--surface); border-radius:10px;">
          <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">CHO Solidi</div>
          <div style="font-size:1.8rem; font-weight:800; color:var(--accent3); font-family:'JetBrains Mono',monospace;">${fmt(totalChoFood, 0)} g</div>
        </div>

        <!-- CHO Liquidi -->
        <div style="text-align:center; padding:16px; background:var(--surface); border-radius:10px;">
          <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">CHO Liquidi Rimanenti</div>
          <div style="font-size:1.8rem; font-weight:800; color:var(--accent); font-family:'JetBrains Mono',monospace;">${fmt(choLiquid, 0)} g</div>
        </div>

        <!-- Liquidi per osm ottimale -->
        <div style="text-align:center; padding:16px; background:var(--surface); border-radius:10px;">
          <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Liquidi per Osm Ottimale</div>
          <div style="font-size:1.8rem; font-weight:800; color:var(--accent4); font-family:'JetBrains Mono',monospace;">${fmt(liquidForOptimalOsm / 1000, 2)} l</div>
          <div style="font-size:0.8rem; color:var(--text-muted); margin-top:6px; font-weight:600;">${fmt(liquidForOptimalOsm / cfg.bottleVol, 1)} borracce</div>
        </div>

        <!-- Liquidi per osm custom -->
        <div style="text-align:center; padding:16px; background:var(--surface); border-radius:10px;">
          <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Liquidi per Osm Custom</div>
          <div style="font-size:1.8rem; font-weight:800; color:var(--accent2); font-family:'JetBrains Mono',monospace;">${computedOsm !== null ? fmt((choLiquid * 100) / computedOsm / 1000, 2) + ' l' : '‚Äî'}</div>
          <div style="font-size:0.8rem; color:var(--text-muted); margin-top:6px; font-weight:600;">${computedOsm !== null ? fmt(((choLiquid * 100) / computedOsm) / cfg.bottleVol, 1) + ' borracce' : '‚Äî'}</div>
        </div>

        <!-- Osm custom -->
        <div style="text-align:center; padding:16px; background:var(--surface); border-radius:10px;">
          <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Osm per CHO inseriti</div>
          <div style="font-size:1.8rem; font-weight:800; color:var(--accent4); font-family:'JetBrains Mono',monospace;">${computedOsm !== null ? fmt(computedOsm,1) + '%' : '‚Äî'}</div>
        </div>
      </div>

      <!-- Borracce -->
      <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
        <!-- Riga 1 -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <!-- Borraccia Ottimale -->
          <div style="padding:16px; background:rgba(16,185,129,0.1); border:1px solid var(--accent4); border-radius:10px;">
            <div style="font-size:0.8rem; font-weight:600; color:var(--accent4); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">‚ö° Borraccia Ottimale</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:2px;">Volume: ${cfg.bottleVol} ml</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px;">Osmolarit√†: ${fmt(cfg.targetOsm, 1)}%</div>
            <div style="font-size:1.4rem; font-weight:800; color:var(--accent4); font-family:'JetBrains Mono',monospace;">${fmt(borr2Mass, 0)} g carboidrati</div>
            <div style="font-size:0.7rem; color:var(--text-muted); margin-top:4px;">(${fmt(borr2Cho, 0)} g CHO effettivi)</div>
          </div>
          <!-- Borraccia Iperconcentrata con Ottimale -->
          <div style="padding:16px; background:rgba(245,158,11,0.1); border:1px solid var(--accent5); border-radius:10px;">
            <div style="font-size:0.8rem; font-weight:600; color:var(--accent5); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">üî• Iperconcentrata - Ottimale</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:2px;">Volume: ${cfg.bottleVol} ml</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px;">CHO liquidi - borraccia ottimale</div>
            <div style="font-size:1.4rem; font-weight:800; color:var(--accent5); font-family:'JetBrains Mono',monospace;">${fmt(borrIperOptimalCho, 0)} g CHO</div>
          </div>
        </div>
        
        <!-- Riga 2 -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <!-- Borraccia Custom -->
          <div style="padding:16px; background:rgba(124,58,237,0.1); border:1px solid var(--accent2); border-radius:10px;">
            <div style="font-size:0.8rem; font-weight:600; color:var(--accent2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">üíß Borraccia Custom</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:2px;">Volume: ${cfg.bottleVol} ml</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px;">Osmolarit√†: ${computedOsm !== null ? fmt(computedOsm, 1) + '%' : '‚Äî'}</div>
            <div style="font-size:1.4rem; font-weight:800; color:var(--accent2); font-family:'JetBrains Mono',monospace;">${computedOsm !== null ? fmt(borrCustomMass, 0) + ' g carboidrati' : '‚Äî'}</div>
            <div style="font-size:0.7rem; color:var(--text-muted); margin-top:4px;">${computedOsm !== null ? '(' + fmt((cfg.bottleVol * computedOsm) / 100, 0) + ' g CHO effettivi)' : ''}</div>
          </div>
          <!-- Borraccia Iperconcentrata -->
          <div style="padding:16px; background:rgba(244,63,94,0.1); border:1px solid var(--accent3); border-radius:10px;">
            <div style="font-size:0.8rem; font-weight:600; color:var(--accent3); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">üî• Borraccia Iperconcentrata</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:2px;">Volume: ${cfg.bottleVol} ml</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px;">CHO rimanenti distribuiti</div>
            <div style="font-size:1.4rem; font-weight:800; color:var(--accent3); font-family:'JetBrains Mono',monospace;">${fmt(borrIperCho, 0)} g CHO</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('configRow').insertAdjacentHTML('afterend', summaryHtml);
}

function addSegment() {
  segments.push({ name:'Nuovo', km:0, h:0, min:0, carbo:null, carboInt:0, malto:0, consum:null, foodItems:[] });
  debouncedRenderAll();
}

function removeSegment(index) {
  if (segments.length > 1) {
    segments.splice(index, 1);
    debouncedRenderAll();
  }
}

function renderTable() {
  let hdr = `<thead><tr>
    <th style="text-align:left">Tratto</th>
    <th>km</th><th>h</th><th>min</th>
    <th class="col-div">Tot ore</th><th>Tot min</th>
    <th class="col-div">‚àÜ km</th>
    <th class="col-div">Vel. Media</th><th>Vel. Tratto</th>
    <th style="width:120px">Azioni</th>
  </tr></thead>`;

  let rows = computed.map((c,i) => {
    const canRemove = segments.length > 1;
    return `<tr>
      <td><input type="text" value="${c.name}" oninput="segments[${i}].name=this.value;debouncedRenderAll()"></td>
      <td><input type="number" value="${segments[i].km}" oninput="segments[${i}].km=+this.value;debouncedRenderAll()"></td>
      <td><input type="number" value="${segments[i].h}" oninput="segments[${i}].h=+this.value;debouncedRenderAll()"></td>
      <td><input type="number" value="${segments[i].min}" oninput="segments[${i}].min=+this.value;debouncedRenderAll()"></td>
      <td class="col-div calc">${c.cumH}</td>
      <td class="calc">${c.cumM}</td>
      <td class="col-div calc">${c.dKm}</td>
      <td class="col-div calc speed">${fmt(c.avgSpeed)}</td>
      <td class="calc speed">${fmt(c.segSpeed)}</td>
      <td style="text-align:center">
        <button onclick="addSegment()" style="background:var(--accent4); color:#0a0e1a; border:none; border-radius:4px; padding:4px 8px; font-size:0.7rem; cursor:pointer; margin-right:4px;">+</button>
        <button onclick="removeSegment(${i})" ${canRemove ? '' : 'disabled'} style="background:${canRemove ? 'var(--accent3)' : 'var(--surface3)'}; color:${canRemove ? '#0a0e1a' : 'var(--text-muted)'}; border:none; border-radius:4px; padding:4px 8px; font-size:0.7rem; cursor:${canRemove ? 'pointer' : 'not-allowed'};">‚àí</button>
      </td>
    </tr>`;
  }).join('');

  document.getElementById('segTable').innerHTML = hdr + `<tbody>${rows}</tbody>`;
}



function renderFoods() {
  const foodTypes = ['barretta', 'gel', 'caramelle', 'panino', 'banana', 'altro'];
  let hdr = `<thead><tr>
    <th style="text-align:left">Alimento</th>
    <th class="col-div">gr CHO/unit√†</th>
    <th>oppure</th>
    <th>% CHO</th>
    <th>gr Alimento</th>
    <th class="col-div">Quantit√†</th>
    <th>CHO Totale</th>
    <th>Caffeina</th>
    <th style="width:120px">Azioni</th>
  </tr></thead>`;

  let rows = foods.map((f, i) => {
    // Logica di calcolo:
    // Metodo 1: gr CHO/unit√† √ó Quantit√†
    // Metodo 2: (gr Alimento √ó % CHO / 100) √ó Quantit√†
    let calcCho = 0;
    const qty = f.qty || 1; // Se qty non √® compilato, usa 1

    if (f.grCho !== null && f.grCho !== '') {
      calcCho = f.grCho * qty;
    } else if (f.pctCho !== null && f.grFood !== null && f.grFood !== '') {
      calcCho = (f.grFood * f.pctCho / 100) * qty;
    }

    const canRemove = foods.length > 1;
    const isCustom = f.type === 'altro';
    return `<tr>
      <td>
        <select onchange="foods[${i}].type=this.value;debouncedRenderAll()" class="food-select">
          ${foodTypes.map(t => `<option value="${t}" ${f.type === t ? 'selected' : ''}>${t}</option>`).join('')}
        </select>
        ${isCustom ? `<input type="text" placeholder="‚úèÔ∏è Scrivi il nome dell'alimento..." value="${f.customName || ''}" oninput="foods[${i}].customName=this.value;debouncedRenderAll()" style="width:100%; margin-top:4px; font-size:0.75rem; padding:4px 6px; background:transparent; border:none; color:var(--text); font-family:'Outfit',sans-serif; font-weight:500;">` : ''}
      </td>
      <td class="col-div"><input type="number" step="0.1" value="${f.grCho || ''}" placeholder="es. 30" oninput="foods[${i}].grCho=this.value?+this.value:null; foods[${i}].pctCho=null; foods[${i}].grFood=null; debouncedRenderAll()"></td>
      <td style="color:var(--accent2); font-weight:600; font-size:0.8rem; text-align:center; background: rgba(124,58,237,0.05);">OR</td>
      <td><input type="number" step="0.1" value="${f.pctCho || ''}" placeholder="es. 75" oninput="foods[${i}].pctCho=this.value?+this.value:null; foods[${i}].grCho=null; debouncedRenderAll()"></td>
      <td><input type="number" step="0.1" value="${f.grFood || ''}" placeholder="es. 100" oninput="foods[${i}].grFood=this.value?+this.value:null; foods[${i}].grCho=null; debouncedRenderAll()"></td>
      <td class="col-div"><input type="number" value="${f.qty || ''}" placeholder="es. 3" oninput="foods[${i}].qty=this.value?+this.value:null;debouncedRenderAll()"></td>
      <td class="calc">${fmt(calcCho, 0)}</td>
      <td style="text-align:center;">
        <input type="range" min="0" max="200" step="10" value="${f.caffeineMg || 0}" oninput="foods[${i}].caffeineMg=+this.value; document.getElementById('caffeine-${i}').textContent=(this.value == 0 ? 'no' : this.value + ' mg'); debouncedRenderAll()" style="width:80px; -webkit-appearance: none; background: var(--surface3); border-radius: 5px; outline: none; ::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }"><br><span id="caffeine-${i}" style="font-size:0.7rem; color:var(--text-muted);">${f.caffeineMg === 0 ? 'no' : (f.caffeineMg || 0) + ' mg'}</span>
      </td>
      <td style="text-align:center">
        <button onclick="addFood()" style="background:var(--accent4); color:#0a0e1a; border:none; border-radius:4px; padding:4px 8px; font-size:0.7rem; cursor:pointer; margin-right:4px;">+</button>
        <button onclick="removeFood(${i})" ${canRemove ? '' : 'disabled'} style="background:${canRemove ? 'var(--accent3)' : 'var(--surface3)'}; color:${canRemove ? '#0a0e1a' : 'var(--text-muted)'}; border:none; border-radius:4px; padding:4px 8px; font-size:0.7rem; cursor:${canRemove ? 'pointer' : 'not-allowed'};">‚àí</button>
      </td>
    </tr>`;
  }).join('');

  // Calcola il totale CHO
  const totalCho = foods.reduce((sum, f) => {
    let calcCho = 0;
    const qty = f.qty || 1;
    if (f.grCho !== null && f.grCho !== '') {
      calcCho = f.grCho * qty;
    } else if (f.pctCho !== null && f.grFood !== null && f.grFood !== '') {
      calcCho = (f.grFood * f.pctCho / 100) * qty;
    }
    return sum + calcCho;
  }, 0);

  document.getElementById('foodTable').innerHTML = hdr + `<tbody>${rows}</tbody>`;
  document.getElementById('foodSummary').innerHTML = `
    <div style="text-align:center; padding:16px; font-size:1.1rem; color:var(--text);">
      <span style="color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.75rem;">CHO Totali Disponibili</span>
      <div style="font-size:2rem; font-weight:800; font-family:'JetBrains Mono',monospace; background:linear-gradient(135deg, var(--accent5), var(--accent3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-top:4px;">${fmt(totalCho, 0)} g</div>
    </div>
  `;
}

function renderNutrition(meta) {
  const colors = ['#00e5ff','#7c3aed','#f43f5e','#10b981','#f59e0b','#06b6d4','#8b5cf6','#ec4899'];
  
  let html;
  
  if (nutritionView === 'cards') {
    html = computed.map((c,i) => {
      const seg = segments[i];
      const choPlanned = seg.carbo !== null && seg.carbo !== '' ? Number(seg.carbo) : null;
      const choIng = calcSegmentChoIng(seg);
      const choBorr = choPlanned !== null ? Math.max(0, choPlanned - choIng) : 0;
      
      // CHO cumulativo: somma di tutti i carboCalc fino a questo indice incluso
      const choTotal = computed.slice(0, i + 1).reduce((sum, seg) => sum + seg.carboCalc, 0);
      
      // Calculate cumulative CHO planned total
      const choPlanTotal = segments.slice(0, i + 1).reduce((sum, s) => {
        const planned = s.carbo !== null && s.carbo !== '' ? Number(s.carbo) : 0;
        return sum + planned;
      }, 0);
      
      // Render lista degli alimenti selezionati
      let foodRows = '';
      if (seg.foodItems && seg.foodItems.length > 0) {
        foodRows = seg.foodItems.map((item, rowIdx) => {
          const food = foods[item.foodIndex];
          const label = foodLabel(food);
          const perUnit = calcFoodChoPerUnit(food);
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
              <span style="font-weight:500; flex:1;">${label}</span>
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="color:var(--accent3); font-weight:600; font-family:'JetBrains Mono',monospace; font-size:0.8rem; min-width:50px; text-align:right;">${fmt(perUnit,0)} g</span>
                <button onclick="removeSegmentFood(${i}, ${rowIdx})" style="background:var(--accent3); color:#0a0e1a; border:none; border-radius:6px; padding:4px 8px; font-size:0.7rem; cursor:pointer; min-width:24px; height:24px; display:flex; align-items:center; justify-content:center;">√ó</button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      const foodTableHtml = `
        <div style="margin-top:16px; padding:12px; background:var(--surface2); border-radius:10px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-weight:600;">Solidi</span>
            <button onclick="addSegmentFood(${i})" style="background:var(--accent4); color:#0a0e1a; border:none; border-radius:6px; padding:4px 10px; font-size:0.7rem; cursor:pointer; font-weight:600;">+ AGGIUNGI</button>
          </div>
          ${seg.foodItems && seg.foodItems.length > 0 ? `
            <div style="display:flex; flex-direction:column; gap:2px;">
              ${foodRows}
            </div>
          ` : '<div style="font-size:0.8rem; color:var(--text-muted); text-align:center; padding:16px 0; font-style:italic;">Nessun alimento selezionato</div>'}
        </div>
      `;
      
      return `
        <div class="nut-card" style="animation-delay:${i*0.06}s;">
          <div class="card-glow" style="background:${colors[i%colors.length]}"></div>
          <div class="nt-header">
            <span class="nt-name">${c.name}</span>
            <span class="nt-km">${c.km} km ¬∑ ${fmtDuration(c.segMin)}</span>
          </div>
          <div class="nt-stats">
            <div class="nt-stat"><div class="st-label">CHO Calcolato</div><div class="st-val accent5">${fmt(c.carboCalc,0)} g</div></div>
            <div class="nt-stat"><div class="st-label">CHO Total</div><div class="st-val accent">${fmt(choTotal,0)} g</div></div>
            <div class="nt-stat"><div class="st-label">CHO Solidi</div><div class="st-val accent3">${fmt(choIng,0)} g</div></div>
            <div class="nt-stat"><div class="st-label">CHO Borraccia</div><div class="st-val accent4">${choPlanned !== null ? fmt(choBorr,0) + ' g' : '‚Äî'}</div></div>
          </div>
          <div style="margin-bottom:16px; margin-top:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <label style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-weight:600;">CHO Pianificato (g)</label>
              <div style="font-size:0.7rem; color:var(--accent2); font-weight:600; font-family:'JetBrains Mono',monospace;">Tot: ${fmt(choPlanTotal,0)} g</div>
            </div>
            <input type="number" value="${choPlanned !== null ? choPlanned : ''}" placeholder="Inserisci CHO totale" oninput="segments[${i}].carbo=this.value?+this.value:null;debouncedRenderAll()" style="width:100%; font-size:1.2rem; font-weight:700; font-family:'JetBrains Mono',monospace; padding:10px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--accent2); text-align:center;">
          </div>
          ${foodTableHtml}
        </div>
      `;
    }).join('');
  } else if (nutritionView === 'grid') {
    // Grid view: table with key data
    const tableRows = computed.map((c,i) => {
      const seg = segments[i];
      const choPlanned = seg.carbo !== null && seg.carbo !== '' ? Number(seg.carbo) : null;
      const choIng = calcSegmentChoIng(seg);
      const choBorr = choPlanned !== null ? Math.max(0, choPlanned - choIng) : 0;
      const choTotal = computed.slice(0, i + 1).reduce((sum, seg) => sum + seg.carboCalc, 0);
      
      // Calculate cumulative CHO planned total
      const choPlanTotal = segments.slice(0, i + 1).reduce((sum, s) => {
        const planned = s.carbo !== null && s.carbo !== '' ? Number(s.carbo) : 0;
        return sum + planned;
      }, 0);
      
      // Build food items list for grid view
      let foodList = '';
      if (seg.foodItems && seg.foodItems.length > 0) {
        foodList = seg.foodItems.map((item, rowIdx) => {
          const food = foods[item.foodIndex];
          const label = foodLabel(food);
          return `<div style="display:flex; align-items:center; justify-content:space-between; padding:4px 0; font-size:0.8rem;">
            <span>${label}</span>
            <button onclick="removeSegmentFood(${i}, ${rowIdx})" style="background:var(--accent3); color:#0a0e1a; border:none; border-radius:4px; padding:2px 6px; font-size:0.6rem; cursor:pointer; margin-left:8px;">√ó</button>
          </div>`;
        }).join('');
      }
      
      return `
        <tr>
          <td style="padding:12px; border-bottom:1px solid var(--border); font-weight:600;">${c.name}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center;">${c.km} km</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center;">${fmtDuration(c.segMin)}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent5); font-weight:600;">${fmt(c.carboCalc,0)}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent); font-weight:600;">${fmt(choTotal,0)}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent3); font-weight:600;">${fmt(choIng,0)}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent4); font-weight:600;">${choPlanned !== null ? fmt(choBorr,0) : '‚Äî'}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center;">
            <input type="number" value="${choPlanned !== null ? choPlanned : ''}" placeholder="‚Äî" oninput="segments[${i}].carbo=this.value?+this.value:null;debouncedRenderAll()" style="width:80px; font-size:0.9rem; font-weight:600; font-family:'JetBrains Mono',monospace; padding:6px 8px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--accent2); text-align:center;">
          </td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent2); font-weight:600; font-family:'JetBrains Mono',monospace;">${fmt(choPlanTotal, 0)}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:left;">
            <div style="display:flex; flex-direction:column;">
              ${foodList}
              <button onclick="addSegmentFood(${i})" style="background:var(--accent4); color:#0a0e1a; border:none; border-radius:6px; padding:4px 8px; font-size:0.7rem; cursor:pointer; font-weight:600; margin-top:4px;">+</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    html = `
      <div class="table-scroll">
        <table style="width:100%; background:var(--surface); border-radius:12px; overflow:hidden; border-collapse:collapse;">
          <thead>
            <tr style="background:var(--surface2);">
              <th style="padding:16px; text-align:left; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Tratto</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Km</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Tempo</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">CHO Calc</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">CHO Tot</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">CHO Solidi</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">CHO Borr</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Pianificato</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">CHO Plan Tot</th>
              <th style="padding:16px; text-align:left; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Alimenti Solidi</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
    `;
  }
  
  document.getElementById('nutGrid').innerHTML = html;
  document.getElementById('nutGrid').className = `nut-grid ${nutritionView}-view`;
}

function renderBottles(meta) {
  // Calculate CHO values like in recalc()
  const totalTime = computed.reduce((sum, c) => sum + c.segMin, 0) / 60;
  const totalChoCalc = cfg.carbPerHour * totalTime;
  const totalChoFood = foods.reduce((sum, f) => {
    const qty = f.qty || 0;
    const grCho = f.grCho || 0;
    const pctCho = f.pctCho || 100;
    return sum + (qty * grCho * pctCho / 100);
  }, 0);
  const choLiquid = totalChoCalc - totalChoFood;
  
  const borr1Cho = Number(cfg.choPerBottle) || 0;
  const borrIperCho = Math.max(0, choLiquid - borr1Cho);

  // Use correct values for each bottle type
  const easyCho = cfg.choPerBottle || 0;  // Borraccia Easy uses CHO per Borraccia
  const iperCho = borrIperCho;            // Borraccia Iper uses üî• Borraccia Iperconcentrata

  const grIper  = cfg.bottleVol - iperCho;
  const pctIper = iperCho / grIper;
  const osmPct  = easyCho / cfg.bottleVol;

  // Configuration cards (always shown)
  document.getElementById('bottleConfig').innerHTML = `
    <div class="bottle-card">
      <h4>üíß Borraccia Easy (osmotica)</h4>
      <div class="bc-row"><span class="bc-label">Volume totale</span><span class="bc-val">${cfg.bottleVol} ml</span></div>
      <div class="bc-row"><span class="bc-label">Gr Maltodestrina</span><span class="bc-val green">${fmt(easyCho, 0)} g</span></div>
      <div class="bc-row"><span class="bc-label">% Osm</span><span class="bc-val">${fmt(osmPct*100,2)}%</span></div>
    </div>
    <div class="bottle-card">
      <h4>‚öóÔ∏è Borraccia Iper (concentrata)</h4>
      <div class="bc-row"><span class="bc-label">Volume totale</span><span class="bc-val">${cfg.bottleVol} ml</span></div>
      <div class="bc-row"><span class="bc-label">Gr Maltodestrina</span><span class="bc-val amber">${fmt(iperCho, 0)} g</span></div>
      <div class="bc-row"><span class="bc-label">Gr acqua (iper)</span><span class="bc-val purple">${fmt(grIper, 0)} g</span></div>
      <div class="bc-row"><span class="bc-label">Rapporto malto/acqua</span><span class="bc-val">${fmt(pctIper,3)}</span></div>
    </div>
  `;

  let html;
  if (bottleView === 'compact') {
    // Compact view: table with key data
    let cumConsum = 0;
    const tableRows = computed.map((c,i) => {
      const seg = segments[i];
      const hasConsum = c.consum !== null;
      cumConsum += c.consum;
      const prevCum = cumConsum - c.consum;
      const needsRefill = Math.floor(cumConsum) > Math.floor(prevCum) && iperCho > 0;
      return `
        <tr>
          <td style="padding:12px; border-bottom:1px solid var(--border); font-weight:600;">${c.name}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center;">${c.km} km</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent5); font-weight:600;">${segments[i].malto} g</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent); font-weight:600;">${fmt(c.borFrac,3)}</td>
          ${hasConsum ? `
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent4); font-weight:600;">${fmt(c.consum, 1)}</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--blue); font-weight:600;">${fmt((c.consum * cfg.bottleVol) / 1000, 2)} l</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent2); font-weight:600;">${fmt(c.refillMl,0)} ml</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent2); font-weight:600;">${fmt(c.refillH2OmL,0)} ml</td>
          <td style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:${needsRefill ? 'var(--warning)' : 'var(--accent3)'}; font-weight:600;">${needsRefill ? '‚ö†Ô∏è S√¨' : '‚Äî'}</td>
          ` : `
          <td colspan="5" style="padding:12px; border-bottom:1px solid var(--border); text-align:center; color:var(--accent3); font-style:italic;">Nessun consumo registrato</td>
          `}
        </tr>
      `;
    }).join('');
    
    html = `
      <div class="table-scroll">
        <table style="width:100%; background:var(--surface); border-radius:12px; overflow:hidden; border-collapse:collapse;">
          <thead>
            <tr style="background:var(--surface2);">
              <th style="padding:16px; text-align:left; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Tratto</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Km</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Malto</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Fraz. Borr</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Consumo</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Consumo ml</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Iper Cons</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">H‚ÇÇO Cons</th>
              <th style="padding:16px; text-align:center; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Refill</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
    `;
  } else {
    // Cards view: detailed cards
    let cumConsum = 0;
    html = computed.map((c,i) => {
      const hasConsum = c.consum !== null;
      cumConsum += c.consum;
      const prevCum = cumConsum - c.consum;
      const needsRefill = Math.floor(cumConsum) > Math.floor(prevCum) && iperCho > 0;
      return `
        <div class="bottle-card" style="animation-delay:${i*0.05}s">
          <h4>üíß ${c.name} ‚Äî ${c.km} km</h4>
          <div class="bc-row"><span class="bc-label">Malto in borraccia</span><span class="bc-val green">${segments[i].malto} g</span></div>
          ${hasConsum ? `
          <div class="bc-row"><span class="bc-label">Consumo borracce</span><span class="bc-val amber">${fmt(c.consum, 1)}</span></div>
          <div class="bc-row"><span class="bc-label">Consumo ml</span><span class="bc-val blue">${fmt((c.consum * cfg.bottleVol) / 1000, 2)} l</span></div>
          ${needsRefill ? `
          <div class="bc-row" style="background:var(--warning-bg); border:1px solid var(--warning); border-radius:6px; padding:8px; margin:8px 0; cursor:pointer;" onclick="showRefillModal(${i})">
            <span class="bc-label" style="color:var(--warning); font-weight:600;">‚ö†Ô∏è Refill necessario</span>
          </div>
          ` : ''}
          ` : '<div class="bc-row"><span class="bc-label" style="color:var(--accent3)">Nessun consumo registrato</span></div>'}
        </div>`;
    }).join('');
  }
  
  document.getElementById('bottleCards').innerHTML = html;
  document.getElementById('bottleCards').className = `bottle-row ${bottleView}-view`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ECHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chartInstances = {};

function renderCharts() {
  const names  = computed.map(c => c.name);
  const segSpd = computed.map(c => +c.segSpeed.toFixed(1));
  const avgSpd = computed.map(c => +c.avgSpeed.toFixed(1));
  const carbCalc = computed.map(c => +c.carboCalc.toFixed(1));
  const carbPlan = segments.map(s => s.carbo);
  const maltos   = segments.map(s => s.malto);
  const borFracs = computed.map(c => +c.borFrac.toFixed(2));
  const cumBors  = computed.map(c => +c.cumBor.toFixed(2));
  const cumTimes = computed.map(c => +c.cumTimeDec.toFixed(2));
  const dTimes   = computed.map(c => +c.dTime.toFixed(2));

  const baseText = { color:'#64748b', fontSize:11 };
  const baseAxis = { axisLabel:{ color:'#64748b', fontSize:10 }, axisLine:{ lineStyle:{ color:'#243044' }}, splitLine:{ lineStyle:{ color:'#1a2236' }}};

  // ‚îÄ‚îÄ Speed ‚îÄ‚îÄ
  initChart('chartSpeed', {
    tooltip:{ trigger:'axis', backgroundColor:'#1a2236', borderColor:'#243044', textStyle:{ color:'#e2e8f0' }},
    legend:{ textStyle:baseText, left:'center', top:4 },
    grid:{ top:36, bottom:28, left:40, right:20 },
    xAxis:{ ...baseAxis, data:names, type:'category' },
    yAxis:{ ...baseAxis, type:'value', name:'km/h', nameTextStyle:baseText },
    series:[
      { name:'Tratto', type:'bar', data:segSpd, barWidth:28,
        itemStyle:{ borderRadius:[6,6,0,0], color:'#00e5ff' },
        label:{ show:true, position:'top', color:'#00e5ff', fontSize:11, fontWeight:600 }
      },
      { name:'Media Cumulativa', type:'line', data:avgSpd, smooth:true,
        lineStyle:{ color:'#f59e0b', width:2.5 },
        itemStyle:{ color:'#f59e0b' },
        symbol:'circle', symbolSize:6
      }
    ]
  });

  // ‚îÄ‚îÄ Carbs ‚îÄ‚îÄ
  initChart('chartCarbs', {
    tooltip:{ trigger:'axis', backgroundColor:'#1a2236', borderColor:'#243044', textStyle:{ color:'#e2e8f0' }},
    legend:{ textStyle:baseText, left:'center', top:4 },
    grid:{ top:36, bottom:28, left:40, right:20 },
    xAxis:{ ...baseAxis, data:names, type:'category' },
    yAxis:{ ...baseAxis, type:'value', name:'g', nameTextStyle:baseText },
    series:[
      { name:'Calcolati (80g/h)', type:'bar', data:carbCalc, barWidth:20, barGap:'-100%',
        itemStyle:{ borderRadius:[4,4,0,0], color:'rgba(245,158,11,0.4)' }
      },
      { name:'Piano', type:'bar', data:carbPlan, barWidth:20,
        itemStyle:{ borderRadius:[4,4,0,0], color:'#f59e0b' }
      },
      { name:'Malto', type:'line', data:maltos, smooth:true,
        lineStyle:{ color:'#10b981', width:2.5 },
        itemStyle:{ color:'#10b981' },
        symbol:'circle', symbolSize:6
      }
    ]
  });

  // ‚îÄ‚îÄ Bottle consumption ‚îÄ‚îÄ
  initChart('chartBottle', {
    tooltip:{ trigger:'axis', backgroundColor:'#1a2236', borderColor:'#243044', textStyle:{ color:'#e2e8f0' }},
    legend:{ textStyle:baseText, left:'center', top:4 },
    grid:{ top:36, bottom:28, left:40, right:20 },
    xAxis:{ ...baseAxis, data:names, type:'category' },
    yAxis:{ ...baseAxis, type:'value', name:'Borracce', nameTextStyle:baseText },
    series:[
      { name:'Fraz. Borraccia', type:'bar', data:borFracs, barWidth:28,
        itemStyle:{ borderRadius:[6,6,0,0],
          color: function(p){ const v=p.value; return v>0.7?'#f43f5e':v>0.4?'#f59e0b':'#10b981'; }
        },
        label:{ show:true, position:'top', color:'#e2e8f0', fontSize:10 }
      },
      { name:'Cumulativa', type:'line', data:cumBors, smooth:true,
        lineStyle:{ color:'#7c3aed', width:2.5 },
        itemStyle:{ color:'#7c3aed' },
        symbol:'circle', symbolSize:6
      }
    ]
  });

  // ‚îÄ‚îÄ Time profile ‚îÄ‚îÄ
  initChart('chartTime', {
    tooltip:{ trigger:'axis', backgroundColor:'#1a2236', borderColor:'#243044', textStyle:{ color:'#e2e8f0' }},
    legend:{ textStyle:baseText, left:'center', top:4 },
    grid:{ top:36, bottom:28, left:40, right:20 },
    xAxis:{ ...baseAxis, data:names, type:'category' },
    yAxis:[
      { ...baseAxis, type:'value', name:'Tempo Cum. (h)', nameTextStyle:baseText },
      { ...baseAxis, type:'value', name:'‚àÜ Tempo (h)', nameTextStyle:{ ...baseText, color:'#f43f5e' }, position:'right' }
    ],
    series:[
      { name:'Tempo Cumulativo', type:'line', data:cumTimes, smooth:true,
        lineStyle:{ color:'#00e5ff', width:3 },
        itemStyle:{ color:'#00e5ff' },
        areaStyle:{ color:{ type:'linear', x:0, y:0, x2:0, y2:1,
          colorStops:[{ offset:0, color:'rgba(0,229,255,0.25)' },{ offset:1, color:'rgba(0,229,255,0)' }]
        }},
        symbol:'circle', symbolSize:6
      },
      { name:'‚àÜ Tempo Tratto', type:'bar', data:dTimes, barWidth:22, yAxisIndex:1,
        itemStyle:{ borderRadius:[4,4,0,0], color:'rgba(244,63,94,0.6)' }
      }
    ]
  });

  // ‚îÄ‚îÄ Caffeine decay ‚îÄ‚îÄ
  // Calcola caffeina accumulata da ogni segmento e decadimento nel tempo
  function calcCaffeineAtTime(timeHours) {
    // Calcola quanto caffeine √® in circolo al momento timeHours
    // Assume che la caffeina sia assunta a met√† di ogni segmento
    let totalCaffeine = 0;
    let cumulativeTime = 0;

    segments.forEach((seg, segIdx) => {
      // Caffeina da questo segmento
      let segCaffeine = 0;
      if (seg.foodItems && seg.foodItems.length > 0) {
        seg.foodItems.forEach(fi => {
          const foodObj = foods[fi.foodIndex];
          if (foodObj && foodObj.caffeineMg > 0) {
            segCaffeine += foodObj.caffeineMg || 0;
          }
        });
      }

      const dTime = computed[segIdx] ? computed[segIdx].dTime : 0;
      const intakeTimeHours = cumulativeTime + dTime / 2; // assunta a met√† segmento

      if (segCaffeine > 0 && intakeTimeHours <= timeHours) {
        // La caffeina √® stata assunta prima di timeHours
        const hoursPassed = timeHours - intakeTimeHours;
        const remaining = segCaffeine * Math.pow(0.5, hoursPassed / cfg.caffeineHalfLife);
        totalCaffeine += remaining;
      }
      
      cumulativeTime += dTime;
    });

    return Math.max(0, totalCaffeine);
  }

  // Calcola caffeina a fine di ogni segmento
  const caffeineAtEnd = [];
  computed.forEach((c, i) => {
    caffeineAtEnd.push(Math.round(calcCaffeineAtTime(c.cumTimeDec) * 10) / 10);
  });

  // Grafico caffeina
  initChart('chartCaffeine', {
    tooltip:{ trigger:'axis', backgroundColor:'#1a2236', borderColor:'#243044', textStyle:{ color:'#e2e8f0' }},
    legend:{ textStyle:baseText, left:'center', top:4 },
    grid:{ top:36, bottom:28, left:40, right:20 },
    xAxis:{ ...baseAxis, data:names, type:'category' },
    yAxis:{ ...baseAxis, type:'value', name:'mg', nameTextStyle:baseText },
    series:[
      { name:'Caffeina in circolo', type:'line', data:caffeineAtEnd, smooth:true,
        lineStyle:{ color:'#f59e0b', width:3 },
        itemStyle:{ color:'#f59e0b' },
        areaStyle:{ color:{ type:'linear', x:0, y:0, x2:0, y2:1,
          colorStops:[{ offset:0, color:'rgba(245,158,11,0.3)' },{ offset:1, color:'rgba(245,158,11,0)' }]
        }},
        symbol:'circle', symbolSize:6
      }
    ]
  });
}

function initChart(id, option) {
  const el = document.getElementById(id);
  if (!el) return;
  if (chartInstances[id]) { chartInstances[id].dispose(); }
  const chart = echarts.init(el);
  chart.setOption(option);
  chartInstances[id] = chart;
  window.addEventListener('resize', () => chart.resize());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  document.querySelector(`[onclick="switchTab('${name}')"]`).classList.add('active');
  
  // Update view buttons based on tab
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  if (name === 'nutrition') {
    document.querySelector(`[onclick="setNutritionView('${nutritionView}')"]`).classList.add('active');
  } else if (name === 'bottles') {
    document.querySelector(`[onclick="setBottleView('${bottleView}')"]`).classList.add('active');
    document.getElementById('bottleCards').className = `bottle-row ${bottleView}-view`;
  }
  
  if (name === 'charts') setTimeout(renderCharts, 100);
}

function setNutritionView(view) {
  nutritionView = view;
  // Only update if we're on the nutrition tab
  if (document.getElementById('tab-nutrition').classList.contains('active')) {
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[onclick="setNutritionView('${view}')"]`).classList.add('active');
    renderAll();
  }
}

function setBottleView(view) {
  bottleView = view;
  // Only update if we're on the bottles tab
  if (document.getElementById('tab-bottles').classList.contains('active')) {
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[onclick="setBottleView('${view}')"]`).classList.add('active');
    document.getElementById('bottleCards').className = `bottle-row ${view}-view`;
    renderAll();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL DIALOG ‚Äî Osmolarit√†
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showOsmDialog() {
  const levels = [
    { label: 'üü¢ Leggera', osm: 4, note: 'Meno concentrata, pi√π tollerabile' },
    { label: 'üü° Standard', osm: 6, note: 'Bilanciata, consigliata' },
    { label: 'üî¥ Forte', osm: 8, note: 'Pi√π concentrata, ottima assimilazione' }
  ];
  
  const tableHtml = `
    <table class="osm-table">
      <thead>
        <tr>
          <th>Livello</th>
          <th>Osm %</th>
          <th>Gr CHO<br/>(${cfg.bottleVol}ml)</th>
          <th>Caratteristica</th>
        </tr>
      </thead>
      <tbody>
        ${levels.map(level => {
          const cho = Math.round((level.osm / 100) * cfg.bottleVol);
          return `
            <tr>
              <td class="label">${level.label}</td>
              <td class="value">${level.osm}%</td>
              <td class="value">${cho} g</td>
              <td class="note">${level.note}</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
  
  document.getElementById('osmTableContainer').innerHTML = tableHtml;
  document.getElementById('osmModal').classList.add('active');
}

function closeOsmDialog() {
  document.getElementById('osmModal').classList.remove('active');
}

function showChoDialog() {
  document.getElementById('choModal').classList.add('active');
}

function closeChoDialog() {
  document.getElementById('choModal').classList.remove('active');
}

function showCarbDialog() {
  updateCarbReminder();
  document.getElementById('carbModal').classList.add('active');
}

function closeCarbDialog() {
  document.getElementById('carbModal').classList.remove('active');
}

function showCaffeineDialog() {
  document.getElementById('caffeineModal').classList.add('active');
}

function closeCaffeineDialog() {
  document.getElementById('caffeineModal').classList.remove('active');
}

function showCaffeineFormula() {
  document.getElementById('caffeineModal').classList.add('active');
}

function closeCaffeineFormula() {
  document.getElementById('caffeineModal').classList.remove('active');
}

function showChoBottleDialog() {
  document.getElementById('choBottleModal').classList.add('active');
}

function closeChoBottleDialog() {
  document.getElementById('choBottleModal').classList.remove('active');
}

function showSolidiDialog() {
  document.getElementById('solidiModal').classList.add('active');
}

function closeSolidiDialog() {
  document.getElementById('solidiModal').classList.remove('active');
}

function showRefillModal(segmentIndex) {
  const c = computed[segmentIndex];
  const modal = document.getElementById('refillModal');
  const content = document.getElementById('refillContent');
  
  // Recalculate iperCho
  const totalTime = computed.reduce((sum, c) => sum + c.segMin, 0) / 60;
  const totalChoCalc = cfg.carbPerHour * totalTime;
  const totalChoFood = foods.reduce((sum, f) => {
    const qty = f.qty || 0;
    const grCho = f.grCho || 0;
    const pctCho = f.pctCho || 100;
    return sum + (qty * grCho * pctCho / 100);
  }, 0);
  const choLiquid = totalChoCalc - totalChoFood;
  const borr1Cho = Number(cfg.choPerBottle) || 0;
  const iperCho = Math.max(0, choLiquid - borr1Cho);
  
  // Calculate cumulative consumption up to this segment
  let cumConsum = 0;
  for (let j = 0; j <= segmentIndex; j++) {
    cumConsum += computed[j].consum;
  }
  
  const refillFraction = cumConsum - Math.floor(cumConsum);
  const choNecessario = refillFraction * cfg.choPerBottle;
  const volumeIper = iperCho > 0 ? (choNecessario * cfg.bottleVol) / iperCho : 0;
  const acqua = cfg.bottleVol - volumeIper;
  
  let html = `
    <div style="padding:16px; background:var(--surface); border-radius:10px; border:1px solid var(--border);">
      <h4 style="margin:0 0 12px 0; color:var(--accent);">üìã Dettagli Refill dopo ${c.name}</h4>
      <div style="display:grid; gap:8px; font-size:0.9rem;">
        <div><strong>Consumo cumulativo:</strong> ${fmt(cumConsum, 1)} borracce</div>
        <div><strong>Frazione da refillare:</strong> ${fmt(refillFraction, 2)} borracce</div>
        <div><strong>CHO necessario:</strong> ${fmt(choNecessario, 0)} g</div>
        <div style="margin-top:8px; padding:8px; background:var(--surface2); border-radius:6px;">
          <strong>üíß Preparazione:</strong><br>
          ${fmt(volumeIper, 0)} ml borraccia iperconcentrata<br>
          + ${fmt(acqua, 0)} ml acqua
        </div>
      </div>
    </div>
  `;
  
  content.innerHTML = html;
  modal.style.display = 'flex';
}

function closeRefillModal() {
  document.getElementById('refillModal').style.display = 'none';
}

function updateCarbReminder() {
  const carbs = cfg.carbPerHour;
  let reminder = '';
  
  if (carbs <= 60) {
    reminder = `<strong>‚úÖ ${carbs} gr/h:</strong> Solo glucosio/maltodestrine. Nessun fruttosio necessario.`;
  } else if (carbs <= 70) {
    const fruct = carbs - 60;
    reminder = `<strong>‚ö†Ô∏è ${carbs} gr/h:</strong> Glucosio ${Math.round(60)}g + Fruttosio ${Math.round(fruct)}g`;
  } else if (carbs <= 100) {
    const fruct = carbs - 60;
    reminder = `<strong>‚ö†Ô∏è ${carbs} gr/h:</strong> Glucosio 60g + Fruttosio ${Math.round(fruct)}g`;
  } else {
    const fruct = carbs - 60;
    reminder = `<strong>‚ö†Ô∏è ${carbs} gr/h:</strong> Glucosio 60g + Fruttosio ${Math.round(fruct)}g (consigliato rapporto 1:1)`;
  }
  
  document.getElementById('carbReminder').innerHTML = reminder;
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
  const osmModal = document.getElementById('osmModal');
  const choModal = document.getElementById('choModal');
  const carbModal = document.getElementById('carbModal');
  const caffeineModal = document.getElementById('caffeineModal');
  const choBottleModal = document.getElementById('choBottleModal');
  if (e.target === osmModal) {
    osmModal.classList.remove('active');
  }
  if (e.target === choModal) {
    choModal.classList.remove('active');
  }
  if (e.target === carbModal) {
    carbModal.classList.remove('active');
  }
  if (e.target === caffeineModal) {
    caffeineModal.classList.remove('active');
  }
  if (e.target === choBottleModal) {
    choBottleModal.classList.remove('active');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Fix typo in carbs chart series reference
window.onload = () => {
  // Set initial view button
  document.querySelector(`[onclick="setNutritionView('${nutritionView}')"]`).classList.add('active');
  renderAllWithCharts();
};
</script>
</body>
</html>
